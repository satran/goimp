# This file must not be executed rather sourced.

# Remove any trailing slashes
GOPATH=${GOPATH%/} 

export OLD_WD=$(pwd)
export OLD_GOPATH=$GOPATH

TMP=$(mktemp -d)
VENDOR=vendor.img

# Create a new image if it does not exist
if [ ! -f $VENDOR ];
then
    dd if=/dev/zero of=$VENDOR bs=1M count=1 seek=254
    mkfs.ext4 $VENDOR
fi

sudo mount $VENDOR $TMP

echo "setting GOPATH to $TMP"
PKG=${PWD/#"${GOPATH}"/}
PKGPATH=$TMP/$PKG
sudo mkdir -p $PKGPATH
sudo chown -R $USER $TMP 
sudo mount --bind $PWD $PKGPATH
export GOPATH=$TMP
cd $PKGPATH

function cleanup {
    echo "unmounting..."
    cd $OLD_WD
    sudo umount -R $TMP
}

trap "cleanup" EXIT
