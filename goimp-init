#!/bin/sh
set -e

cd $(realpath .)

# Remove any trailing slashes
GOPATH=${GOPATH%/} 

export OLD_WD=$(pwd)
export OLD_GOPATH=$GOPATH

TMP=$(mktemp -d)
[[ -e "vendor.tar" ]] && tar -xf vendor.tar -C "$TMP"

echo "setting GOPATH to $TMP"
PKG=${PWD/#"${GOPATH}"/}
PKGPATH=$TMP/$PKG
mkdir -p $(dirname $PKGPATH)
[[ -e "$PKGPATH" ]] || ln -s "$PWD" "$PKGPATH"
export GOPATH=$TMP
cd $PKGPATH

(set +e; goimp get)
if [ -z "$PS1" ]; then
	export PS1="[go] $(basename $PKGPATH)=> "
else
	export PS1="[go] $PS1"
fi
$SHELL

function cleanup {
    set +e
    rm "$PKGPATH"
    cd $OLD_WD
    tar -cf vendor.tar -C "$TMP" .
    rm -fr "$TMP"
}

trap "cleanup" EXIT
